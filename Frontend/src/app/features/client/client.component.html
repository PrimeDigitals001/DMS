<div class="client-container">
  <p-toast position="top-right" [breakpoints]="{'920px': {width: '100%', right: '0', left: '0'}}"></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
  <h1>Clients</h1>

  <div class="top-bar">
    <div class="search-section">
      <p-floatlabel variant="on">
        <input
          pInputText
          id="on_label"
          [(ngModel)]="searchQuery"
          autocomplete="off"
          class="w-full"
          [disabled]="loading"
        />
        <label for="on_label">Quick search a Client</label>
      </p-floatlabel>
    </div>

    <div class="total">
      <h3>{{ totalClients }}</h3>
      <p>Total number of Clients</p>
    </div>
    <p-button 
      label="Add New Client" 
      (onClick)="showDialog()"
      [disabled]="loading"
      icon="pi pi-plus"
      styleClass="add-btn"
    ></p-button>
  </div>

  <div class="table-section">
    <h3>All Clients</h3>
    
    @if (loading) {
      <div class="loading-container">
        <p-progressSpinner 
          styleClass="w-4rem h-4rem" 
          strokeWidth="3"
          animationDuration=".5s"
        ></p-progressSpinner>
      </div>
    } @else {
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Client</th>
              <th>Owner Name</th>
              <th class="phone-col">Phone No.</th>
              <th class="email-col">Email</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (client of clients | searchFilter : searchQuery; track client._id) {
              <tr>
                <td [attr.data-label]="'Client'">{{ client.client }}</td>
                <td [attr.data-label]="'Owner Name'">{{ client.ownerName }}</td>
                <td [attr.data-label]="'Phone No.'" class="phone-col">{{ client.phoneNumber }}</td>
                <td [attr.data-label]="'Email'" class="email-col">{{ client.email }}</td>
                <td [attr.data-label]="'Actions'" class="actions-col">
                  <div class="action-buttons">
                    <button
                      pButton
                      icon="pi pi-pencil"
                      class="p-button-rounded p-button-text p-button-info"
                      (click)="showDialog(client)"
                      pTooltip="Edit client"
                      tooltipPosition="top"
                    ></button>
                    <button
                      pButton
                      icon="pi pi-trash"
                      class="p-button-rounded p-button-text p-button-danger"
                      (click)="deleteClient(client)"
                      pTooltip="Delete client"
                      tooltipPosition="top"
                    ></button>
                  </div>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="5" class="empty-message">
                  @if (searchQuery) {
                    <span>No clients found matching "{{ searchQuery }}"</span>
                  } @else {
                    <span>No clients available. Click "Add New Client" to get started.</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<p-dialog
  [header]="editMode ? 'Edit Client' : 'Add New Client'"
  [modal]="true"
  [(visible)]="visible"
  [style]="{ width: '90vw', maxWidth: '500px' }"
  [contentStyle]="{ overflow: 'visible' }"
  [closable]="!submitting"
  [closeOnEscape]="!submitting"
  (onHide)="closeDialog()"
  [breakpoints]="{'960px': '75vw', '640px': '95vw'}"
  [draggable]="false"
  [resizable]="false"
>
  <form
    [formGroup]="clientForm"
    (ngSubmit)="editMode ? editClient() : addClient()"
    class="client-form"
  >
    <span class="p-text-secondary block mb-4">
      @if (editMode) {
        Update the client information below.
      } @else {
        Please fill in the client details below. All fields are required.
      }
    </span>

    <div class="field">
      <label for="client" class="field-label">
        Client Name <span class="required">*</span>
      </label>
      <input
        pInputText
        id="client"
        formControlName="client"
        class="w-full"
        placeholder="Enter client name"
        [class.ng-invalid]="hasError('client')"
        [class.ng-dirty]="hasError('client')"
        [disabled]="submitting"
      />
      @if (hasError('client')) {
        <small class="p-error">
          {{ getErrorMessage('client') }}
        </small>
      }
    </div>

    <div class="field">
      <label for="ownerName" class="field-label">
        Owner Name <span class="required">*</span>
      </label>
      <input
        pInputText
        id="ownerName"
        formControlName="ownerName"
        class="w-full"
        placeholder="Enter owner name"
        [class.ng-invalid]="hasError('ownerName')"
        [class.ng-dirty]="hasError('ownerName')"
        [disabled]="submitting"
      />
      @if (hasError('ownerName')) {
        <small class="p-error">
          {{ getErrorMessage('ownerName') }}
        </small>
      }
    </div>

    <div class="field">
      <label for="phoneNumber" class="field-label">
        Phone Number <span class="required">*</span>
      </label>
      <input
        pInputText
        id="phoneNumber"
        formControlName="phoneNumber"
        class="w-full"
        placeholder="Enter phone number (10 digits)"
        maxlength="10"
        [class.ng-invalid]="hasError('phoneNumber')"
        [class.ng-dirty]="hasError('phoneNumber')"
        [disabled]="submitting"
      />
      @if (hasError('phoneNumber')) {
        <small class="p-error">
          {{ getErrorMessage('phoneNumber') }}
        </small>
      }
    </div>

    <div class="field">
      <label for="email" class="field-label">
        Email <span class="required">*</span>
      </label>
      <input
        pInputText
        id="email"
        formControlName="email"
        class="w-full"
        placeholder="Enter email address"
        [class.ng-invalid]="hasError('email')"
        [class.ng-dirty]="hasError('email')"
        [disabled]="submitting"
      />
      @if (hasError('email')) {
        <small class="p-error">
          {{ getErrorMessage('email') }}
        </small>
      }
    </div>

    <div class="dialog-footer">
      <p-button
        type="button"
        label="Cancel"
        severity="secondary"
        (onClick)="closeDialog()"
        [disabled]="submitting"
        styleClass="p-button-text"
      ></p-button>
      <p-button
        type="submit"
        [label]="editMode ? 'Update Client' : 'Add Client'"
        [loading]="submitting"
        [disabled]="submitting || clientForm.invalid"
        icon="pi pi-check"
      ></p-button>
    </div>
  </form>
</p-dialog>