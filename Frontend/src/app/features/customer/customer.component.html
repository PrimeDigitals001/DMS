<div class="customer-container">
  <p-toast position="top-right" [breakpoints]="{'920px': {width: '100%', right: '0', left: '0'}}"></p-toast>
  <p-confirmDialog></p-confirmDialog>
  
  <h2>Customers</h2>

  <div class="top-bar">
    <div class="search-section">
      <p-floatlabel variant="on">
        <input
          pInputText
          id="on_label"
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearchChange()"
          autocomplete="off"
          class="w-full"
          [disabled]="loading"
          [placeholder]="'Search a Customer'"
        />
        <!-- <label for="on_label">Quick search a Customer</label> -->
      </p-floatlabel>
    </div>

    <div class="total">
      <h3>{{ totalCustomers }}</h3>
      <p>Total number of Customers</p>
    </div>
    <p-button 
      label="Add New Customer" 
      (click)="showDialog()"
      [disabled]="loading"
      icon="pi pi-plus"
      styleClass="add-btn"
    ></p-button>
  </div>

  <div class="table-section">
    <h3>All Customers</h3>
    
    @if (loading) {
      <div class="loading-container">
        <p-progressSpinner 
          styleClass="w-4rem h-4rem" 
          strokeWidth="3"
          animationDuration=".5s"
        ></p-progressSpinner>
      </div>
    } @else {
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width: 8%">S.No</th>
              <th style="width: 32%">Customer Name</th>
              <th style="width: 30%">Phone No.</th>
              <th style="width: 10%">View Invoice</th>
              <th style="width: 8%">Action</th>
            </tr>
          </thead>
          <tbody>
            @for (customer of pagedCustomers; track customer._id; let i = $index) {
              <tr>
                <td [attr.data-label]="'S.No'">{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                <td [attr.data-label]="'Customer Name'">{{ customer.customerName }}</td>
                <td [attr.data-label]="'Phone No.'">{{ customer.phoneNumber }}</td>
                <td [attr.data-label]="'View Invoice'">
                  <button
                    pButton
                    icon="pi pi-file-pdf"
                    class="p-button-rounded p-button-text p-button-success"
                    (click)="viewInvoices(customer)"
                    pTooltip="View invoices"
                    tooltipPosition="top"
                  ></button>
                </td>
                <td>
                  <button
                    pButton
                    icon="pi pi-pencil"
                    class="p-button-rounded p-button-text p-button-info"
                    (click)="showDialog(customer)"
                    pTooltip="Edit customer"
                    tooltipPosition="top"
                  ></button>
                  <button
                    pButton
                    icon="pi pi-trash"
                    class="p-button-rounded p-button-text p-button-danger"
                    (click)="deleteCustomer(customer)"
                    pTooltip="Delete customer"
                    tooltipPosition="top"
                  ></button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="empty-message">
                  @if (searchQuery) {
                    <span>No customers found matching "{{ searchQuery }}"</span>
                  } @else {
                    <span>No customers available. Click "Add New Customer" to get started.</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </table>
        <div class="page-size">
          <span>Showing {{ (currentPage - 1) * itemsPerPage + 1 }}-
            {{ (currentPage * itemsPerPage) < totalFiltered ? (currentPage * itemsPerPage) : totalFiltered }} of {{ totalFiltered }}</span>
          <div class="action-buttons" style="justify-content: flex-end; margin-top: 8px;">
            <button pButton icon="pi pi-angle-left" class="p-button-text" (click)="goToPage(currentPage - 1)"></button>
            @for (page of totalPagesArray; track page) {
              <button pButton class="p-button-text" [label]="page.toString()" (click)="goToPage(page)"></button>
            }
            <button pButton icon="pi pi-angle-right" class="p-button-text" (click)="goToPage(currentPage + 1)"></button>
          </div>
        </div>
      </div>
    }
  </div>
</div>

<p-dialog
  [header]="editMode ? 'Edit Customer' : 'Add New Customer'"
  [modal]="true"
  [(visible)]="visible"
  [style]="{ width: '90vw', maxWidth: '500px' }"
  [contentStyle]="{ overflow: 'visible' }"
  [closable]="!submitting"
  [closeOnEscape]="!submitting"
  (onHide)="closeDialog()"
  [breakpoints]="{'960px': '75vw', '640px': '95vw'}"
  [draggable]="false"
  [resizable]="false"
>
  <form
    [formGroup]="customerForm"
    (ngSubmit)="onSubmit()"
    class="customer-form"
  >
    <span class="p-text-secondary block mb-4">
      @if (editMode) {
        Update the customer information below.
      } @else {
        Please fill in the customer details below. All fields are required.
      }
    </span>

    @if (customerForm.get('rfid')?.value) {
      <div class="field" style="margin-top: -0.5rem;">
        <div class="p-3" style="background: #eff6ff; border: 1px solid #93c5fd; border-radius: 10px; display: flex; align-items: center; justify-content: space-between;">
          <div>
            <span class="p-text-secondary" style="font-size: 0.9rem;">RFID</span>
            <div><strong class="font-mono" style="font-size: 1.05rem;">{{ customerForm.get('rfid')?.value }}</strong></div>
          </div>
          @if (editMode) {
            <button pButton type="button" class="p-button-text" icon="pi pi-id-card" label="Rescan" (click)="openRfidDialog()" [disabled]="submitting"></button>
          }
        </div>
      </div>
    } @else {
      <div class="field" style="margin-top: -0.5rem;">
        <div class="p-3" style="background: #fff7ed; border: 1px solid #fed7aa; border-radius: 10px; display: flex; align-items: center; justify-content: space-between;">
          <span class="p-text-secondary">No RFID scanned</span>
          <button pButton type="button" class="p-button-text" icon="pi pi-id-card" label="Scan RFID" (click)="openRfidDialog()" [disabled]="submitting"></button>
        </div>
      </div>
    }

    <div class="field">
      <label for="customerName" class="field-label">
        Customer Name <span class="required">*</span>
      </label>
      <input
        pInputText
        id="customerName"
        formControlName="customerName"
        class="w-full"
        placeholder="Enter customer name"
        [class.ng-invalid]="hasError('customerName')"
        [class.ng-dirty]="hasError('customerName')"
        [disabled]="submitting"
      />
      @if (hasError('customerName')) {
        <small class="p-error">
          {{ getErrorMessage('customerName') }}
        </small>
      }
    </div>

    <div class="field">
      <label for="phoneNumber" class="field-label">
        Phone Number <span class="required">*</span>
      </label>
      <input
        pInputText
        id="phoneNumber"
        formControlName="phoneNumber"
        class="w-full"
        placeholder="Enter phone number (10 digits)"
        maxlength="10"
        [class.ng-invalid]="hasError('phoneNumber')"
        [class.ng-dirty]="hasError('phoneNumber')"
        [disabled]="submitting"
      />
      @if (hasError('phoneNumber')) {
        <small class="p-error">
          {{ getErrorMessage('phoneNumber') }}
        </small>
      }
    </div>

    <!-- RFID input removed: RFID is managed via scan modal and displayed at top only -->

    <div class="dialog-footer">
      <p-button
        type="button"
        label="Cancel"
        severity="secondary"
        (click)="closeDialog()"
        [disabled]="submitting"
        styleClass="p-button-text"
      ></p-button>
      <p-button
        type="submit"
        [label]="editMode ? 'Update Customer' : 'Add Customer'"
        [loading]="submitting"
        [disabled]="submitting || customerForm.invalid"
        icon="pi pi-check"
      ></p-button>
    </div>
  </form>
</p-dialog>

<!-- RFID Input Dialog -->
<p-dialog
  header="Tap Your RFID"
  [modal]="true"
  [(visible)]="rfidDialogVisible"
  [style]="{ width: '90vw', maxWidth: '480px' }"
  [closable]="!rfidValidating"
  [closeOnEscape]="!rfidValidating"
  [draggable]="false"
  [resizable]="false"
>
  <div class="field">
    <input
      pInputText
      [(ngModel)]="rfidInput"
      placeholder="RFID will appear here..."
      class="w-full"
      [disabled]="rfidValidating"
      autocomplete="off"
    />
  </div>
  @if (rfidError) {
    <small class="p-error">{{ rfidError }}</small>
  }
  <div class="dialog-footer">
    <p-button type="button" label="Cancel" styleClass="p-button-text" (click)="cancelRfidDialog()" [disabled]="rfidValidating"></p-button>
    <p-button type="button" label="Continue" icon="pi pi-check" (click)="confirmRfid()" [disabled]="!rfidInput || rfidValidating" [loading]="rfidValidating"></p-button>
  </div>
</p-dialog>